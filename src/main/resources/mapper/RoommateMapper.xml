<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 반드시 IRoommateMapper.java 와 일치 -->
<mapper namespace="kopo.shallwithme.mapper.IRoommateMapper">

    <!-- 유저 태그 조회 -->
    <select id="findByUserId" parameterType="string" resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            ut.user_id  AS userId,
            ut.tag_id   AS tagId,
            t.tag_name  AS tagName
        FROM USER_TAG ut
                 JOIN TAG t ON t.tag_id = ut.tag_id
        WHERE ut.user_id = #{userId}
        ORDER BY ut.tag_id DESC
    </select>

    <!-- 룸메이트 카드 리스트 (페이징) -->
    <select id="getRoommateList" resultType="map">
        SELECT
            ui.user_id    AS userId,
            ui.user_name  AS userName,
            ui.age        AS age,
            ui.gender     AS gender,
            up.profile_image_url AS profileImageUrl,
            up.introduction
        FROM USER_INFO ui
                 LEFT JOIN USER_PROFILE up ON ui.user_id = up.user_id
        WHERE ui.status = 'ACTIVE'   <!-- ✅ 활성 계정만 -->
        ORDER BY ui.reg_dt DESC
            LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 성별, 기본정보 조회 -->
    <select id="getUserById" parameterType="string"
            resultType="kopo.shallwithme.dto.UserInfoDTO">
        SELECT USER_ID AS userId,
               GENDER  AS gender
        FROM USER_INFO
        WHERE USER_ID = #{userId}
    </select>


    <!-- 태그만 따로 조회 -->
    <select id="selectUserTags" parameterType="string" resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            ut.user_id  AS userId,
            ut.tag_id   AS tagId,
            t.tag_name  AS tagName
        FROM USER_TAG ut
                 JOIN TAG t ON t.tag_id = ut.tag_id
        WHERE ut.user_id = #{userId}
        ORDER BY ut.tag_id DESC
    </select>

    <select id="findUserProfileById" parameterType="string" resultType="kopo.shallwithme.dto.UserProfileDTO">
        SELECT
        u.user_id          AS userId,
        u.user_name        AS userName,
        u.age              AS age,
        u.gender           AS gender,
        u.addr1            AS addr1,
        u.birth_date       AS birthDate,
        p.profile_image_url AS profileImageUrl,  <!-- ✅ 여기를 profile_image_url로 맞춤 -->
        p.introduction     AS introduction
        FROM USER_INFO u
        LEFT JOIN USER_PROFILE p ON u.user_id = p.user_id
        WHERE u.user_id = #{userId}
    </select>


    <!-- 전체 유저 수 조회 : 양준모 태그를 통한 검색-->
    <select id="countAllUsers" parameterType="TagDTO" resultType="TagDTO" resultMap="TagDTOResultMap">
        SELECT
            COUNT(user_id) AS count
        FROM USER_INFO
    </select>

    <!-- 태그 필터링 유저 수 조회 -->
    <select id="countUsersByTags" parameterType="TagDTO" resultMap="TagDTOResultMap">
        SELECT
        COUNT(matching_users.userId) as count
        FROM (
        SELECT
        U.USER_ID AS userId
        FROM USER_INFO U
        JOIN USER_TAG UT ON U.USER_ID = UT.USER_ID
        WHERE UT.TAG_ID IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        GROUP BY U.USER_ID
        HAVING COUNT(DISTINCT UT.TAG_ID) = #{tagCount}
        ) AS matching_users
    </select>

    <!-- resultMap 정의 -->
    <resultMap id="TagDTOResultMap" type="TagDTO">
        <result property="count" column="count"/>
    </resultMap>

    <select id="getAllTags" resultType="TagDTO">
        SELECT TAG_ID, TAG_NAME
        FROM TAG
    </select>


    <select id="selectUsersByPagination" parameterType="TagDTO" resultType="UserInfoDTO">
        SELECT
            ui.user_id    AS userId,
            ui.user_name  AS userName,
            ui.age        AS age,
            ui.gender     AS gender,
            up.profile_image_url AS profileImageUrl,
            up.introduction
        FROM USER_INFO ui
                 LEFT JOIN USER_PROFILE up ON ui.user_id = up.user_id
        WHERE ui.status = 'ACTIVE'
        ORDER BY ui.reg_dt DESC
            LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <select id="selectUsersByTagsWithPagination" parameterType="TagDTO" resultType="UserInfoDTO">
        SELECT
        ui.user_id    AS userId,
        ui.user_name  AS userName,
        ui.age        AS age,
        ui.gender     AS gender,
        up.profile_image_url AS profileImageUrl,
        up.introduction
        FROM USER_INFO ui
        JOIN USER_TAG ut ON ui.user_id = ut.user_id
        LEFT JOIN USER_PROFILE up ON ui.user_id = up.user_id
        WHERE ui.status = 'ACTIVE'
        AND ut.tag_id IN
        <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
        GROUP BY ui.user_id
        HAVING COUNT(DISTINCT ut.tag_id) = #{tagCount}
        ORDER BY ui.reg_dt DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

</mapper>
