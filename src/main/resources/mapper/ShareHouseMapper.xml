<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kopo.shallwithme.mapper.ISharehouseMapper">

    <!-- 목록: 대표 썸네일 1장, 최신 등록순 + ✅ floor_number + ADDRESS, DETAIL_ADDRESS 추가 -->
    <select id="listCards"
            parameterType="map"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
        sh.house_id      AS houseId,
        sh.house_name    AS title,
        sh.description   AS subText,
        sh.ADDRESS       AS address,
        sh.DETAIL_ADDRESS AS detailAddress,
        sh.floor_number  AS floorNumber,
        (SELECT shi.url
        FROM SHARE_HOUSE_IMAGE shi
        WHERE shi.house_id = sh.house_id
        ORDER BY shi.sort_order ASC, shi.img_id ASC
        LIMIT 1)        AS coverUrl,
        (SELECT shi.url
        FROM SHARE_HOUSE_IMAGE shi
        WHERE shi.house_id = sh.house_id
        ORDER BY shi.sort_order ASC, shi.img_id ASC
        LIMIT 1)        AS thumbnailUrl
        FROM SHARE_HOUSE sh

        <where>
            <if test="location != null and location != ''">
                sh.ADDRESS LIKE CONCAT('%', SUBSTRING(#{location}, 1, 2), '%')
            </if>

            <if test="tagIds != null and tagIds.size() > 0">
                AND sh.house_id IN (
                SELECT sht.house_id
                FROM SHARE_HOUSE_TAG sht
                WHERE sht.house_tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
                GROUP BY sht.house_id
                HAVING COUNT(DISTINCT sht.house_tag_id) = #{tagIdsSize}
                )
            </if>
        </where>

        ORDER BY sh.reg_dt DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 단건 카드 + ✅ floor_number + ADDRESS, DETAIL_ADDRESS + reg_id 추가 -->
    <select id="getCardById"
            parameterType="long"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id      AS houseId,
            sh.house_name    AS title,
            sh.description   AS subText,
            sh.ADDRESS       AS address,
            sh.DETAIL_ADDRESS AS detailAddress,
            sh.floor_number  AS floorNumber,
            sh.reg_id        AS regId,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                LIMIT 1)        AS coverUrl,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
             LIMIT 1)        AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 상세 (DB에 있는 컬럼만) + ✅ floor_number + ADDRESS, DETAIL_ADDRESS 추가 -->
    <select id="getDetail"
            parameterType="long"
            resultType="map">
        SELECT
            sh.house_id      AS houseId,
            sh.house_name    AS title,
            sh.description   AS subText,
            sh.ADDRESS       AS address,
            sh.DETAIL_ADDRESS AS detailAddress,
            sh.image_url     AS coverUrl,
            sh.floor_number  AS floorNumber,
            sh.reg_id        AS regId,
            sh.reg_dt        AS regDt,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                LIMIT 1)        AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 쉐어하우스의 모든 이미지 조회 -->
    <select id="selectSharehouseImages"
            parameterType="long"
            resultType="map">
        SELECT
            img_id     AS imgId,
            house_id   AS houseId,
            url,
            sort_order AS sortOrder,
            reg_dt     AS regDt
        FROM SHARE_HOUSE_IMAGE
        WHERE house_id = #{value}
        ORDER BY sort_order ASC, img_id ASC
    </select>

    <!-- ✅ 쉐어하우스 태그 조회 - 6개 -->
    <select id="selectSharehouseTags"
            parameterType="long"
            resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            st.house_id       AS houseId,
            st.house_tag_id   AS tagId,
            tl.house_tag_name AS tagName
        FROM SHARE_HOUSE_TAG st
                 INNER JOIN SHARE_HOUSE_TAG_LIST tl ON tl.house_tag_id = st.house_tag_id
        WHERE st.house_id = #{value}
        ORDER BY st.house_tag_id
            LIMIT 6
    </select>

    <!-- ✅ 전체 태그 목록 조회 -->
    <select id="getAllTags" resultType="TagDTO">
        SELECT house_tag_id AS tagId, house_tag_name AS tagName
        FROM SHARE_HOUSE_TAG_LIST
        ORDER BY house_tag_id
    </select>

    <!-- ✅ insert: PK 자동반환 + floor_number + ADDRESS, DETAIL_ADDRESS 추가 -->
    <insert id="insertSharehouse"
            parameterType="kopo.shallwithme.dto.SharehouseCardDTO"
            useGeneratedKeys="true" keyProperty="houseId">
        INSERT INTO SHARE_HOUSE
        (house_name, ADDRESS, DETAIL_ADDRESS, description, image_url, floor_number, reg_id, reg_dt)
        VALUES
            (#{title}, COALESCE(#{address}, ''), COALESCE(#{detailAddress}, ''), #{subText}, #{coverUrl}, #{floorNumber}, #{regId}, NOW())
    </insert>

    <!-- 이미지 배치 저장 -->
    <insert id="insertSharehouseImages" parameterType="list">
        INSERT INTO SHARE_HOUSE_IMAGE
        (house_id, url, sort_order, reg_dt)
        VALUES
        <foreach collection="list" item="img" separator=",">
            (#{img.houseId}, #{img.url}, #{img.sortOrder}, NOW())
        </foreach>
    </insert>

    <!-- ✅ 태그 저장 -->
    <insert id="insertSharehouseTags" parameterType="map">
        INSERT INTO SHARE_HOUSE_TAG (house_id, house_tag_id)
        VALUES
        <foreach collection="tagList" item="tagId" separator=",">
            (#{houseId}, #{tagId})
        </foreach>
    </insert>

    <!-- ✅ 기존 태그 삭제 -->
    <delete id="deleteSharehouseTags" parameterType="long">
        DELETE FROM SHARE_HOUSE_TAG
        WHERE house_id = #{value}
    </delete>

    <!-- ✅ 본인의 쉐어하우스 조회 (regId 기준) -->
    <select id="getSharehouseByUserId"
            parameterType="string"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id       AS houseId,
            sh.house_name     AS title,
            sh.description    AS subText,
            sh.ADDRESS        AS address,
            sh.DETAIL_ADDRESS AS detailAddress,
            sh.floor_number   AS floorNumber,
            sh.reg_id         AS regId,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                                 LIMIT 1)         AS coverUrl,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
             LIMIT 1)         AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.reg_id = #{value}
        ORDER BY sh.reg_dt DESC
    </select>

    <!-- ✅ 쉐어하우스 삭제 (house_id 기준) -->
    <delete id="deleteSharehouse" parameterType="long">
        DELETE FROM SHARE_HOUSE
        WHERE house_id = #{value}
    </delete>

    <!-- ✅ 쉐어하우스 이미지 삭제 (house_id 기준) -->
    <delete id="deleteSharehouseImages" parameterType="long">
        DELETE FROM SHARE_HOUSE_IMAGE
        WHERE house_id = #{value}
    </delete>

</mapper>