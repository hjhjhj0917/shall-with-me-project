<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kopo.shallwithme.mapper.ISharehouseMapper">

    <!-- 목록: 대표 썸네일 1장, 최신 등록순 -->
    <select id="listCards"
            parameterType="map"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS coverUrl,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
             LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        ORDER BY sh.reg_dt DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 단건 카드 -->
    <select id="getCardById"
            parameterType="long"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS coverUrl,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
             LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 상세 (DB에 있는 컬럼만) -->
    <select id="getDetail"
            parameterType="long"
            resultType="map">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            sh.address     AS address,
            sh.image_url   AS coverUrl,
            sh.reg_dt      AS regDt,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 쉐어하우스의 모든 이미지 조회 -->
    <select id="selectSharehouseImages"
            parameterType="long"
            resultType="map">
        SELECT
            img_id     AS imgId,
            house_id   AS houseId,
            url,
            sort_order AS sortOrder,
            reg_dt     AS regDt
        FROM SHARE_HOUSE_IMAGE
        WHERE house_id = #{value}
        ORDER BY sort_order ASC, img_id ASC
    </select>

    <!-- ✅ 쉐어하우스 태그 조회 - SHARE_HOUSE_TAG_LIST 참조 -->
    <select id="selectSharehouseTags"
            parameterType="long"
            resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            st.house_id       AS houseId,
            st.house_tag_id   AS tagId,
            tl.house_tag_name AS tagName
        FROM SHARE_HOUSE_TAG st
                 INNER JOIN SHARE_HOUSE_TAG_LIST tl ON tl.house_tag_id = st.house_tag_id
        WHERE st.house_id = #{value}
        ORDER BY st.house_tag_id
            LIMIT 3
    </select>

    <!-- ✅ 전체 태그 목록 조회 - SHARE_HOUSE_TAG_LIST에서 -->
    <select id="getAllTags" resultType="TagDTO">
        SELECT house_tag_id AS tagId, house_tag_name AS tagName
        FROM SHARE_HOUSE_TAG_LIST
        ORDER BY house_tag_id
    </select>

    <!-- insert: PK 자동반환 -->
    <insert id="insertSharehouse"
            parameterType="kopo.shallwithme.dto.SharehouseCardDTO"
            useGeneratedKeys="true" keyProperty="houseId">
        INSERT INTO SHARE_HOUSE
            (house_name, address, description, image_url, reg_id, reg_dt)
        VALUES
            (#{title}, COALESCE(#{address}, ''), #{subText}, #{coverUrl}, #{regId}, NOW())
    </insert>

    <!-- ★★★ 이미지 배치 저장 ★★★ -->
    <insert id="insertSharehouseImages" parameterType="list">
        INSERT INTO SHARE_HOUSE_IMAGE
        (house_id, url, sort_order, reg_dt)
        VALUES
        <foreach collection="list" item="img" separator=",">
            (#{img.houseId}, #{img.url}, #{img.sortOrder}, NOW())
        </foreach>
    </insert>

    <!-- ✅ 태그 저장 (룸메이트와 동일한 방식) -->
    <insert id="insertSharehouseTags" parameterType="map">
        INSERT INTO SHARE_HOUSE_TAG (house_id, house_tag_id)
        VALUES
        <foreach collection="tagList" item="tagId" separator=",">
            (#{houseId}, #{tagId})
        </foreach>
    </insert>

    <!-- ✅ 기존 태그 삭제 (수정 시 사용) -->
    <delete id="deleteSharehouseTags" parameterType="long">
        DELETE FROM SHARE_HOUSE_TAG
        WHERE house_id = #{value}
    </delete>

</mapper>