<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kopo.shallwithme.mapper.ISharehouseMapper">

    <!-- 목록: 대표 썸네일 1장, 최신 등록순 -->
    <select id="listCards"
            parameterType="map"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS coverUrl,
            (SELECT shi.url
               FROM SHARE_HOUSE_IMAGE shi
              WHERE shi.house_id = sh.house_id
              ORDER BY shi.sort_order ASC, shi.img_id ASC
              LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        ORDER BY sh.reg_dt DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 단건 카드 -->
    <select id="getCardById"
            parameterType="long"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS coverUrl,
            (SELECT shi.url
               FROM SHARE_HOUSE_IMAGE shi
              WHERE shi.house_id = sh.house_id
              ORDER BY shi.sort_order ASC, shi.img_id ASC
              LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 상세 (DB에 있는 컬럼만) -->
    <select id="getDetail"
            parameterType="long"
            resultType="map">
        SELECT
            sh.house_id    AS houseId,
            sh.house_name  AS title,
            sh.description AS subText,
            sh.address     AS address,
            sh.image_url   AS coverUrl,
            sh.reg_dt      AS regDt,
            (SELECT shi.url
             FROM SHARE_HOUSE_IMAGE shi
             WHERE shi.house_id = sh.house_id
             ORDER BY shi.sort_order ASC, shi.img_id ASC
                              LIMIT 1)      AS thumbnailUrl
        FROM SHARE_HOUSE sh
        WHERE sh.house_id = #{value}
            LIMIT 1
    </select>

    <!-- 태그 -->
    <select id="selectSharehouseTags"
            parameterType="long"
            resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            st.house_id AS houseId,
            st.tag_id   AS tagId,
            t.tag_name  AS tagName
        FROM SHARE_HOUSE_TAG st
                 JOIN TAG t ON t.tag_id = st.tag_id
        WHERE st.house_id = #{value}
        ORDER BY st.tag_id DESC
    </select>

    <!-- insert: PK 자동반환 -->
    <insert id="insertSharehouse"
            parameterType="kopo.shallwithme.dto.SharehouseCardDTO"
            useGeneratedKeys="true" keyProperty="houseId">
        INSERT INTO SHARE_HOUSE
            (house_name, address, description, image_url, reg_id, reg_dt)
        VALUES
            (#{title}, #{address}, #{subText}, #{coverUrl}, #{regId}, NOW())
    </insert>

</mapper>
