<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 반드시 ISharehouseMapper.java 의 FQN 과 동일 -->
<mapper namespace="kopo.shallwithme.mapper.ISharehouseMapper">

    <!--
      목록 조회 (무한 스크롤)
      ISharehouseService.listCards(int offset, int limit, String city, Integer minRent, Integer maxRent)
      - 파라미터는 Map 으로 들어옵니다.
      - 실제 컬럼/테이블명에 맞춰 alias 로 DTO 필드명(title, subText, price, coverUrl, houseId) 을 매핑합니다.
      - city 필터는 location 컬럼에 매칭, 금액은 rent 에 매칭(필요시 deposit 으로 변경 가능)
    -->
    <select id="listCards"
            parameterType="map"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
        sh.house_id     AS houseId,
        sh.house_name   AS title,        -- DTO.title
        sh.description  AS subText,      -- DTO.subText (없으면 location 으로 바꿔도 됨)
        sh.rent         AS price,        -- DTO.price
        sh.image_url    AS coverUrl      -- DTO.coverUrl
        FROM SHAREHOUSE sh
        <where>
            <if test="city != null and city != ''">
                AND sh.location = #{city}
            </if>
            <if test="minRent != null">
                AND sh.rent &gt;= #{minRent}
            </if>
            <if test="maxRent != null">
                AND sh.rent &lt;= #{maxRent}
            </if>
            <!-- 상태 컬럼이 있다면 주석 해제
            AND sh.status = 'ACTIVE'
            -->
        </where>
        ORDER BY sh.reg_dt DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 단건 카드 조회 (컨트롤러의 /{userId}/info 에서 사용 가능) -->
    <select id="getCardById"
            parameterType="long"
            resultType="kopo.shallwithme.dto.SharehouseCardDTO">
        SELECT
            sh.house_id     AS houseId,
            sh.house_name   AS title,
            sh.description  AS subText,
            sh.rent         AS price,
            sh.image_url    AS coverUrl
        FROM SHAREHOUSE sh
        WHERE sh.house_id = #{houseId}
            LIMIT 1
    </select>

    <!-- 상세 조회: 컨트롤러에서 Map 으로 받으므로 resultType=map -->
    <select id="getDetail"
            parameterType="long"
            resultType="map">
        SELECT
            sh.house_id     AS houseId,
            sh.house_name   AS title,
            sh.description  AS subText,
            sh.rent         AS price,
            sh.deposit      AS deposit,
            sh.image_url    AS coverUrl,
            sh.location     AS city,
            sh.address      AS address,
            sh.available_dt AS availableDt,
            sh.reg_dt       AS regDt
        FROM SHAREHOUSE sh
        WHERE sh.house_id = #{houseId}
            LIMIT 1
    </select>

    <!-- (선택) 태그가 필요하면 사용: DTO.tags 를 채우려면 별도 컬렉션 매핑이 필요하지만,
         지금은 컨트롤러에서 null-safe로 처리하므로 없어도 동작합니다. -->
    <select id="selectSharehouseTags"
            parameterType="long"
            resultType="kopo.shallwithme.dto.UserTagDTO">
        SELECT
            st.house_id AS houseId,
            st.tag_id   AS tagId,
            t.tag_name  AS tagName
        FROM SHAREHOUSE_TAG st
                 JOIN TAG t ON t.tag_id = st.tag_id
        WHERE st.house_id = #{houseId}
        ORDER BY st.tag_id DESC
    </select>

</mapper>
