<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kopo.shallwithme.mapper.IChatMapper">

    <resultMap id="chatMessageResultMap" type="ChatMessageDTO">
        <id property="messageId" column="message_id"/>
        <result property="roomId" column="room_id"/>
        <result property="senderId" column="sender_id"/>
        <result property="message" column="message"/>
        <result property="sentAt" column="sent_at"/>
        <result property="read" column="is_read"/>
        <result property="messageType" column="message_type"/>

        <association property="scheduleRequest"
                     column="schedule_id"
                     javaType="kopo.shallwithme.dto.ScheduleDTO"
                     select="kopo.shallwithme.mapper.IScheduleMapper.getScheduleById"/>
    </resultMap>

    <select id="selectMessagesByRoomId" parameterType="int" resultMap="chatMessageResultMap">
        SELECT
            message_id,
            room_id,
            sender_id,
            message,
            sent_at,
            is_read,
            message_type,
            schedule_id
        FROM
            CHAT_MESSAGE
        WHERE
            room_id = #{value}
        ORDER BY
            sent_at ASC
    </select>

    <insert id="insertChatMessage" parameterType="ChatMessageDTO">
        INSERT INTO CHAT_MESSAGE (
            room_id,
            sender_id,
            message,
            sent_at,
            message_type,
            schedule_id
        )
        VALUES (
                   #{roomId},
                   #{senderId},
                   #{message},
                   #{sentAt},
                   #{messageType},
                   #{scheduleRequest.scheduleId}
               )
    </insert>

    <select id="getOtherUserId" parameterType="ChatRoomDTO" resultType="ChatRoomDTO">
        SELECT USER2_ID, USER1_ID, ROOM_ID
        FROM CHAT_ROOM
        WHERE ROOM_ID = #{roomId}
    </select>

    <select id="selectChatPartnersWithLastMsg"
            parameterType="UserInfoDTO"
            resultType="ChatPartnerDTO">
        SELECT
            U.USER_ID AS userId,
            U.USER_NAME AS userName,
            UP.profile_image_url AS profileImgUrl,
            LM.MESSAGE AS lastMessage,
            DATE_FORMAT(LM.sent_at, '%Y-%m-%dT%H:%i:%s') AS lastMessageTimestamp,
            CASE
                WHEN CR.user1_id = #{userId} THEN CR.user1_unread_count
                ELSE CR.user2_unread_count
                END AS unreadCount
        FROM
            USER_INFO U
                INNER JOIN CHAT_ROOM CR ON (CR.USER1_ID = U.USER_ID AND CR.USER2_ID = #{userId}) OR (CR.USER2_ID = U.USER_ID AND CR.USER1_ID = #{userId})
                LEFT JOIN USER_PROFILE UP ON U.USER_ID = UP.user_id
                INNER JOIN (
                SELECT
                    ROOM_ID,
                    MESSAGE,
                    sent_at,
                    ROW_NUMBER() OVER(PARTITION BY ROOM_ID ORDER BY sent_at DESC) as rn
                FROM CHAT_MESSAGE
            ) AS LM ON CR.ROOM_ID = LM.ROOM_ID AND LM.rn = 1
        WHERE
            U.USER_ID != #{userId}
        ORDER BY
            LM.sent_at DESC,
            U.USER_NAME ASC
    </select>

    <insert id="createChatRoom" useGeneratedKeys="true" keyProperty="roomId" parameterType="ChatRoomDTO">
        INSERT INTO CHAT_ROOM (user1_id, user2_id)
        VALUES (#{user1Id}, #{user2Id})
    </insert>

    <select id="getRoomsByUserId" parameterType="UserInfoDTO" resultType="ChatRoomDTO">
        SELECT room_id, user1_id, user2_id
        FROM CHAT_ROOM
        WHERE user1_id = #{userId} OR user2_id = #{userId}
    </select>

    <select id="selectUserList" resultType="UserInfoDTO">
        SELECT USER_ID AS user_id, USER_NAME AS user_name
        FROM USER_INFO
        ORDER BY USER_NAME
    </select>

    <!-- 방 조회 : user1_id, user2_id 로 방 검색 -->
    <select id="findRoomIdByUsers" parameterType="ChatRoomDTO" resultType="ChatRoomDTO">
        SELECT room_id
        FROM CHAT_ROOM
        WHERE user1_id = #{user1Id} AND user2_id = #{user2Id}
            LIMIT 1
    </select>

    <!-- 방 생성 -->
    <insert id="insertChatRoom" parameterType="ChatRoomDTO"
            useGeneratedKeys="true" keyProperty="roomId">
        INSERT INTO CHAT_ROOM (user1_id, user2_id)
        VALUES (#{user1Id}, #{user2Id})
    </insert>

    <!--    회원 프로필 이미지 불러오기-->
    <select id="selectProfileImageUrlByUserId" resultType="UserProfileDTO" parameterType="ChatRoomDTO">
        SELECT
            U.USER_ID AS userId,
            U.USER_NAME AS userName,
            U.STATUS AS status,
            P.profile_image_url AS profileImageUrl
        FROM
            CHAT_ROOM R
                INNER JOIN
            -- CASE 문을 이용해 채팅방의 두 사용자 중 내가 아닌 사람을 찾아 JOIN 합니다.
                USER_INFO U ON (CASE WHEN R.USER1_ID = #{myUserId} THEN R.USER2_ID ELSE R.USER1_ID END) = U.USER_ID
                LEFT JOIN
            USER_PROFILE P ON U.USER_ID = P.user_id
        WHERE
            R.room_id = #{roomId}
    </select>

    <update id="updateMessageReadStatus">
        UPDATE CHAT_MESSAGE
        SET is_read = TRUE
        WHERE room_id = #{roomId}
          AND sender_id != #{readerId}
          AND is_read = FALSE
    </update>

    <update id="resetUnreadCount">
        UPDATE CHAT_ROOM
        SET
            user1_unread_count = CASE WHEN user1_id = #{readerId} THEN 0 ELSE user1_unread_count END,
            user2_unread_count = CASE WHEN user2_id = #{readerId} THEN 0 ELSE user2_unread_count END
        WHERE
            room_id = #{roomId}
    </update>

    <update id="incrementUnreadCount" parameterType="ChatMessageDTO">
        UPDATE CHAT_ROOM
        SET
            user1_unread_count = CASE WHEN user2_id = #{senderId} THEN user1_unread_count + 1 ELSE user1_unread_count END,
            user2_unread_count = CASE WHEN user1_id = #{senderId} THEN user2_unread_count + 1 ELSE user2_unread_count END
        WHERE
            room_id = #{roomId}
    </update>

    <select id="getTotalUnreadCount" parameterType="String" resultType="int">
        SELECT COALESCE(SUM(CASE
                                WHEN user1_id = #{userId} THEN user1_unread_count
                                WHEN user2_id = #{userId} THEN user2_unread_count
                                ELSE 0
            END), 0)
        FROM CHAT_ROOM
        WHERE user1_id = #{userId} OR user2_id = #{userId}
    </select>

</mapper>
