<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kopo.shallwithme.mapper.IUserInfoMapper">

    <select id="getUserIdExists" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE USER_ID = #{userId}
    </select>

    <select id="getEmailExists" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email}
    </select>

    <select id="emailAuthNumber" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email} AND USER_NAME = #{userName}
    </select>

    <select id="emailAuthNumberPw" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(PASSWORD) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email} AND USER_ID = #{userId}
    </select>

    <select id="getUserForPassword" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT USER_ID, USER_NAME, EMAIL
        FROM USER_INFO
        WHERE USER_ID = #{userId}
          AND EMAIL   = #{email}
            LIMIT 1
    </select>

    <insert id="insertUserInfo" parameterType="UserInfoDTO">
        INSERT INTO USER_INFO
        (USER_ID, USER_NAME, PASSWORD, EMAIL, ADDR1, ADDR2, REG_ID, REG_DT, CHG_ID, CHG_DT, AGE, GENDER, BIRTH_DATE)
        VALUES (#{userId}, #{userName}, #{password}, #{email}, #{addr1}, #{addr2},
                #{userId}, NOW(), #{userId}, NOW(),
                #{age}, #{gender}, #{birthDate})
    </insert>

    <insert id="insertUserTags" parameterType="UserTagDTO">
        INSERT INTO USER_TAG (user_id, tag_id)
        VALUES
        <foreach collection="tagList" item="tag" separator=",">
            (#{userId}, #{tag})
        </foreach>
        ON DUPLICATE KEY UPDATE tag_id = VALUES(tag_id)
    </insert>

    <select id="countUserTags" parameterType="UserTagDTO" resultType="int">
        SELECT COUNT(*) FROM USER_TAG WHERE user_id = #{userId}
    </select>

    <select id="getLogin" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT USER_ID, USER_NAME, EMAIL
        FROM USER_INFO
        WHERE USER_ID = #{userId}
          AND PASSWORD = #{password}
    </select>

    <select id="getUserId" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT USER_ID, USER_NAME, EMAIL
        FROM USER_INFO
        WHERE 1=1
        <if test="userId neq null and userId neq '' ">
            AND USER_ID = #{userId}
        </if>
        AND USER_NAME = #{userName}
        AND EMAIL = #{email}
    </select>

    <update id="updatePassword" parameterType="UserInfoDTO">
        UPDATE USER_INFO
        SET PASSWORD = #{password}
        WHERE USER_ID  = #{userId}
    </update>

    <select id="selectProfileImageUrlByUserId" resultType="string" parameterType="string">
        SELECT profile_image_url
        FROM USER_PROFILE
        WHERE user_id = #{userId}
    </select>

    <select id="getAllUsersWithProfile" resultType="UserInfoDTO">
        SELECT
            u.USER_ID        AS userId,
            u.USER_NAME      AS userName,
            u.PASSWORD       AS password,
            u.EMAIL          AS email,
            u.ADDR1          AS addr1,
            u.ADDR2          AS addr2,
            u.AGE            AS age,
            u.GENDER         AS gender,
            u.BIRTH_DATE     AS birthDate,
            p.PROFILE_IMAGE_URL AS profileImageUrl,
            p.INTRODUCTION      AS introduction
        FROM USER_INFO u
                 LEFT JOIN USER_PROFILE p ON u.USER_ID = p.USER_ID
        ORDER BY u.USER_ID
    </select>

    <select id="getUserTags" parameterType="string" resultType="string">
        SELECT t.tag_name
        FROM USER_TAG ut
                 JOIN TAG t ON ut.tag_id = t.tag_id
        WHERE ut.user_id = #{userId}
    </select>

    <select id="getUserById" parameterType="string" resultType="UserInfoDTO">
        SELECT USER_ID AS userId,
               GENDER  AS gender
        FROM USER_INFO
        WHERE USER_ID = #{userId}
    </select>

    <select id="getUserProfile" parameterType="string" resultType="kopo.shallwithme.dto.UserProfileDTO">
        SELECT
            user_id,
            profile_image_url AS profileImageUrl,
            introduction,
            reg_dt AS regDt,
            chg_dt AS chgDt
        FROM USER_PROFILE
        WHERE user_id = #{userId}
    </select>

    <insert id="upsertUserProfile" parameterType="kopo.shallwithme.dto.UserProfileDTO">
        INSERT INTO USER_PROFILE (user_id, profile_image_url, introduction, reg_dt)
        VALUES (#{userId}, #{profileImageUrl}, #{introduction}, NOW())
            ON DUPLICATE KEY UPDATE
                                 profile_image_url = VALUES(profile_image_url),
                                 introduction      = VALUES(introduction),
                                 chg_dt            = NOW();
    </insert>

    <select id="findUserProfileByUserId"
            parameterType="kopo.shallwithme.dto.UserProfileDTO"
            resultType="kopo.shallwithme.dto.UserProfileDTO">
        SELECT
            ui.USER_ID AS userId,
            ui.USER_NAME AS userName,
            up.profile_image_url AS profileImageUrl,
            up.introduction AS introduction,
            up.reg_dt AS regDt,
            up.chg_dt AS chgDt
        FROM USER_INFO ui
                 LEFT JOIN USER_PROFILE up ON ui.USER_ID = up.user_id
        WHERE ui.USER_ID = #{userId}
    </select>

</mapper>
