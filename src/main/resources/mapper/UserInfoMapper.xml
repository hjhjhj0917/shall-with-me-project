<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="kopo.shallwithme.mapper.IUserInfoMapper">

    <select id="getUserIdExists" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE USER_ID = #{userId}
    </select>

    <select id="getEmailExists" parameterType="UserInfoDTO" resultType="UserinfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email}
    </select>

<!--    아이디 찾기 메일 전송-->
    <select id="emailAuthNumber" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(USER_ID) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email} AND USER_NAME = #{userName}
    </select>

<!--    비밀번호 찾기 메일 전송-->
    <select id="emailAuthNumberPw" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
            IF(COUNT(PASSWORD) > 0, 'Y', 'N') AS EXISTS_YN
        FROM USER_INFO
        WHERE EMAIL = #{email} AND USER_ID = #{userId}
    </select>

    <select id="getUserForPassword" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT USER_ID, USER_NAME, EMAIL
        FROM USER_INFO
        WHERE USER_ID = #{userId}
          AND EMAIL   = #{email}
            LIMIT 1
    </select>

    <insert id="insertUserInfo" parameterType="UserInfoDTO">
        INSERT INTO USER_INFO
        (USER_ID,
         USER_NAME,
         PASSWORD,
         EMAIL,
         ADDR1,
         ADDR2,
         REG_ID,
         REG_DT,
         CHG_ID,
         CHG_DT,
         AGE,
         GENDER,
         BIRTH_DATE)

        VALUES (#{userId},
                #{userName},
                #{password},
                #{email},
                #{addr1},
                #{addr2},
                #{userId},
                NOW(),
                #{userId},
                NOW(),
                #{age},
                #{gender},
                #{birthDate})
    </insert>

    <!-- tag 삽입-->
    <insert id="insertUserTags" parameterType="UserTagDTO" >
        INSERT INTO USER_TAG (user_id, tag_id, tag_type)
        VALUES
        <foreach collection="tagList" item="tag" separator=",">
            (#{userId}, #{tag}, #{tagType})
        </foreach>
        ON DUPLICATE KEY UPDATE user_id=user_id
    </insert>

    <select id="countUserTags" parameterType="UserTagDTO" resultType="int">
        SELECT COUNT(*) FROM USER_TAG WHERE user_id = #{userId}
    </select>

<!-- 로그인을 위해 아이디와 비밀번호가 일치하는지 확인하기 -->
    <select id="getLogin" parameterType="UserInfoDTO" resultType="UserInfoDTO">
            SELECT USER_ID, USER_NAME, EMAIL
            FROM USER_INFO
            WHERE USER_ID = #{userId}
              AND PASSWORD = #{password}
    </select>

    <!--  아이디, 비밀번호 찾기에 활용
    1.이름과 이메일이 맞다면, 아이디 알려주기
    2.아이디, 이름과 이메일이 맞다면, 비밀번호 재설정하기
    -->
    <select id="getUserId" parameterType="UserInfoDTO" resultType="UserInfoDTO">
        SELECT
        USER_ID,
        USER_NAME,
        EMAIL
        FROM USER_INFO
        WHERE 1=1
        <if test="userId neq null and userId neq '' "> <!-- 비밀번호 찾기라면, user_id 조회 추가 -->
            AND USER_ID = #{userId}
        </if>
        AND USER_NAME = #{userName}
        AND EMAIL = #{email}
    </select>

    <!-- 비밀번호 재설설 -->
    <update id="updatePassword" parameterType="UserInfoDTO">
        UPDATE USER_INFO
        SET PASSWORD = #{password}
        WHERE USER_ID  = #{userId}
    </update>

<!--DB에 저장된 태그 불러오기 룸메이트 -->

    <select id="selectUserTags" parameterType="string" resultType="UserTagDTO">
        SELECT t.tag_id    AS tagId,
               t.tag_name  AS tagName,
               ut.tag_type AS tagType
        FROM USER_TAG ut
                 JOIN TAG t ON t.tag_id = ut.tag_id
        WHERE ut.user_id = #{userId}
        ORDER BY ut.tag_type
    </select>


    <!--    회원 프로필 이미지 불러오기-->
    <select id="selectProfileImageUrlByUserId" resultType="string" parameterType="string">
        SELECT profile_image_url
        FROM USER_PROFILE
        WHERE user_id = #{userId}
    </select>

    <select id="getRoommateList" resultType="map">
        SELECT
            u.user_id          AS userId,
            u.user_name        AS userName,
            u.age              AS age,
            u.gender           AS gender,
            p.profile_image_url AS profileImageUrl
        FROM USER_INFO u
                 LEFT JOIN USER_PROFILE p
                           ON u.user_id = p.user_id
        WHERE status = 'ACTIVE'
        ORDER BY u.user_id DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>







    <!-- USER_INFO + USER_PROFILE 조인 -->
    <select id="getAllUsersWithProfile" resultType="UserInfoDTO">
        SELECT
            u.USER_ID        AS userId,
            u.USER_NAME      AS userName,
            u.PASSWORD       AS password,
            u.EMAIL          AS email,
            u.ADDR1          AS addr1,
            u.ADDR2          AS addr2,
            u.AGE            AS age,
            u.GENDER         AS gender,
            u.BIRTH_DATE     AS birthDate,
            p.PROFILE_IMAGE_URL AS profileImageUrl,
            p.INTRODUCTION      AS introduction
        FROM USER_INFO u
                 LEFT JOIN USER_PROFILE p
                           ON u.USER_ID = p.USER_ID
        ORDER BY u.USER_ID
    </select>

    <!-- 유저별 태그 이름 목록 조회 -->
    <select id="getUserTags" parameterType="string" resultType="string">
        SELECT t.tag_name
        FROM USER_TAG ut
                 JOIN TAG t ON ut.tag_id = t.tag_id
        WHERE ut.user_id = #{userId}
    </select>

    <select id="getUserById" parameterType="string" resultType="UserInfoDTO">
        SELECT USER_ID AS userId,
               GENDER  AS gender
        FROM USER_INFO
        WHERE USER_ID = #{userId}
    </select>


</mapper>